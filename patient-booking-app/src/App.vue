<script setup lang="ts">
import { ref, computed, onMounted, watch } from 'vue'
import type { Certificate, Service, BookingFormData, BookingStep, QueueInfo, ServiceBooking, ServiceSchedule, CertificateGroup } from './types'
import { services, getServiceSchedule, getQueueInfo, getCertificateGroups } from './data/mockData'

// –†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
const currentStep = ref<BookingStep>(1)
const queueInfo = ref<QueueInfo>({ length: 8, estimatedWaitTime: 120 })
const currentServiceSchedule = ref<ServiceSchedule | null>(null)
const certificateGroups = ref<CertificateGroup[]>(getCertificateGroups())

// –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const searchQuery = ref('')
const collapsedGroups = ref<Set<string>>(new Set())

const formData = ref<BookingFormData>({
  selectedCertificate: null,
  selectedServices: [],
  serviceBookings: [],
  currentServiceIndex: 0
})

// –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
const filteredCertificateGroups = computed(() => {
  const query = searchQuery.value.toLowerCase().trim()
  if (!query) return certificateGroups.value
  
  return certificateGroups.value.map(group => ({
    ...group,
    certificates: group.certificates.filter(cert => 
      cert.name.toLowerCase().includes(query) || 
      cert.description.toLowerCase().includes(query)
    )
  })).filter(group => group.certificates.length > 0)
})

const availableServices = computed(() => {
  if (!formData.value.selectedCertificate) return []
  return services.filter(service => 
    formData.value.selectedCertificate!.requiredServices.includes(service.id)
  )
})

// –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫
const getMedicalRoute = (certificateId: string, selectedServices: Service[]) => {
  // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —É—Å–ª—É–≥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
  const serviceMap = new Map(selectedServices.map(s => [s.name, s]))
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ø—Ä–∞–≤–∫–∏ (–ø–æ —á–∏—Å–ª–æ–≤–æ–º—É ID)
  let routeType = 'standard'
  
  // –°–ø—Ä–∞–≤–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã - –æ—Å–æ–±—ã–π –º–∞—Ä—à—Ä—É—Ç (076/—É = ID 3, –õ–ú–ö = ID 4, 073/—É = ID 1)
  if (['3', '4', '1'].includes(certificateId)) {
    routeType = 'occupational'
    console.log('–§–æ—Ä–º–∞ 076/—É: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è occupational –º–∞—Ä—à—Ä—É—Ç –¥–ª—è ID', certificateId)
  }
  // –°–ø—Ä–∞–≤–∫–∏ –¥–ª—è –¥–µ—Ç–µ–π - –ø–µ–¥–∏–∞—Ç—Ä–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç (075/—É = ID 2, –ü–∞—Å–ø–æ—Ä—Ç –∑–¥–æ—Ä–æ–≤—å—è = ID 5)
  else if (['2', '5'].includes(certificateId)) {
    routeType = 'pediatric'
  }
  // –ü—Ä–µ–≥—Ä–∞–≤–∏–¥–∞—Ä–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç (ID 9, 10, 11)
  else if (['9', '10', '11'].includes(certificateId)) {
    routeType = 'preconception'
  }
  // –°–∫—Ä–∏–Ω–∏–Ω–≥–∏ - –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç (ID 12, 13, 14, 15)
  else if (['12', '13', '14', '15'].includes(certificateId)) {
    routeType = 'screening'
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å–ª—É–≥
  const getServicesByNames = (names: string[]) => {
    return selectedServices.filter(s => names.includes(s.name))
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–Ω–æ–π —É—Å–ª—É–≥–∏
  const getServiceByName = (name: string) => {
    const service = serviceMap.get(name)
    return service ? [service] : []
  }

  switch (routeType) {
    case 'occupational': // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–¥–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏
      return [
        {
          stage: 1,
          title: 'üöÄ –ü–µ—Ä–≤–∏—á–Ω–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ',
          description: '–¢–µ—Ä–∞–ø–µ–≤—Ç + –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏ (–º–æ–∂–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)',
          icon: '‚ö°',
          services: getServicesByNames(['–¢–µ—Ä–∞–ø–µ–≤—Ç', '–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏ –æ–±—â–∏–π']),
          color: 'var(--primary-color)',
          bgColor: 'var(--certificates-bg)'
        },
        {
          stage: 2,
          title: 'üë• –ò–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å + —Ñ–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏—è',
          description: '–§–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏—è –∏ –∞–Ω–∞–ª–∏–∑—ã –Ω–∞ –∏–Ω—Ñ–µ–∫—Ü–∏–∏ (–≥–µ–ø–∞—Ç–∏—Ç—ã, –í–ò–ß, —Å–∏—Ñ–∏–ª–∏—Å, –∫–∏—à–µ—á–Ω—ã–µ –∏–Ω—Ñ–µ–∫—Ü–∏–∏)',
          icon: 'üè•',
          services: (() => {
            const foundServices = getServicesByNames(['–§–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏—è', '–ì–µ–ø–∞—Ç–∏—Ç—ã B, C –∏ –í–ò–ß', '–ê–Ω–∞–ª–∏–∑ –Ω–∞ —Å–∏—Ñ–∏–ª–∏—Å (RW)', '–ê–Ω–∞–ª–∏–∑ –Ω–∞ –∫–∏—à–µ—á–Ω—ã–µ –∏–Ω—Ñ–µ–∫—Ü–∏–∏'])
            console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ –¥–ª—è 2-–≥–æ —ç—Ç–∞–ø–∞:', foundServices.map(s => s.name))
            return foundServices
          })(),
          color: 'var(--accent-color)',
          bgColor: 'var(--screening-bg)'
        },
        {
          stage: 3,
          title: 'üìã –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞',
          description: '–ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –≤—ã–¥–∞—á–∞ —Å–ø—Ä–∞–≤–∫–∏',
          icon: '‚úÖ',
          services: [], // –¢–µ—Ä–∞–ø–µ–≤—Ç –¥–ª—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è
          color: 'var(--success-color)',
          bgColor: 'var(--preconception-bg)',
          isFinal: true
        }
      ]

         case 'pediatric': // –î–ª—è –¥–µ—Ç—Å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ–∫
       return [
         {
           stage: 1,
           title: 'üöÄ –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ',
           description: '–ü–µ–¥–∏–∞—Ç—Ä, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –∏ –∞–Ω–∞–ª–∏–∑—ã (–≤—Å–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)',
           icon: 'üß∏',
           services: getServicesByNames(['–ü–µ–¥–∏–∞—Ç—Ä', '–ù–µ–≤—Ä–æ–ª–æ–≥', '–û—Ç–æ–ª–∞—Ä–∏–Ω–≥–æ–ª–æ–≥ (–õ–û–†)', '–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥', '–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥', '–û—Ä—Ç–æ–ø–µ–¥', '–ü—Å–∏—Ö–æ–ª–æ–≥', '–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏ –æ–±—â–∏–π', '–ê–Ω–∞–ª–∏–∑ –º–æ—á–∏', '–ê–Ω–∞–ª–∏–∑ –Ω–∞ —ç–Ω—Ç–µ—Ä–æ–±–∏–æ–∑']),
           color: 'var(--accent-color)',
           bgColor: 'var(--screening-bg)'
         },
         {
           stage: 2,
           title: 'üìã –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–µ–¥–∏–∞—Ç—Ä–∞',
           description: '–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏',
           icon: '‚úÖ',
           services: [], // –ü–µ–¥–∏–∞—Ç—Ä –¥–ª—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è
           color: 'var(--primary-color)',
           bgColor: 'var(--certificates-bg)',
           isFinal: true
         }
       ]

     case 'preconception': // –ü—Ä–µ–≥—Ä–∞–≤–∏–¥–∞—Ä–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
       return [
         {
           stage: 1,
           title: 'üöÄ –ü–µ—Ä–≤–∏—á–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏',
           description: '–ì–∏–Ω–µ–∫–æ–ª–æ–≥, –≥–µ–Ω–µ—Ç–∏–∫ –∏ –±–∞–∑–æ–≤—ã–µ –∞–Ω–∞–ª–∏–∑—ã (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)',
           icon: 'üå∏',
           services: getServicesByNames(['–ì–∏–Ω–µ–∫–æ–ª–æ–≥', '–í—Ä–∞—á-–≥–µ–Ω–µ—Ç–∏–∫', '–ê–Ω–∞–ª–∏–∑ –Ω–∞ –∏–Ω—Ñ–µ–∫—Ü–∏–∏ TORCH', '–§–æ–ª–∏–µ–≤–∞—è –∫–∏—Å–ª–æ—Ç–∞ –∏ –í12']),
           color: 'var(--success-color)',
           bgColor: 'var(--preconception-bg)'
         },
         {
           stage: 2,
           title: 'üî¨ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
           description: '–ì–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã + –£–ó–ò + –∫–æ–∞–≥—É–ª–æ–≥—Ä–∞–º–º–∞',
           icon: 'üíâ',
           services: getServicesByNames(['–ì–æ—Ä–º–æ–Ω—ã —Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã', '–ì–æ—Ä–º–æ–Ω—ã —â–∏—Ç–æ–≤–∏–¥–Ω–æ–π –∂–µ–ª–µ–∑—ã', '–ö–æ–∞–≥—É–ª–æ–≥—Ä–∞–º–º–∞', '–£–ó–ò –æ—Ä–≥–∞–Ω–æ–≤ –º–∞–ª–æ–≥–æ —Ç–∞–∑–∞', '–≠—Ö–æ–ö–ì (–£–ó–ò —Å–µ—Ä–¥—Ü–∞)']),
           color: 'var(--info-color)',
           bgColor: 'var(--info-bg)'
         },
         {
           stage: 3,
           title: 'üìã –ò—Ç–æ–≥–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –≥–∏–Ω–µ–∫–æ–ª–æ–≥–∞',
           description: '–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –ø–ª–∞–Ω –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏',
           icon: '‚úÖ',
           services: [], // –ì–∏–Ω–µ–∫–æ–ª–æ–≥ –¥–ª—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è
           color: 'var(--accent-color)',
           bgColor: 'var(--screening-bg)',
           isFinal: true
         }
       ]

     case 'screening': // –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∏
       return [
         {
           stage: 1,
           title: 'üöÄ –ë–∞–∑–æ–≤–æ–µ —Å–∫—Ä–∏–Ω–∏–Ω–≥–æ–≤–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ',
           description: '–¢–µ—Ä–∞–ø–µ–≤—Ç + –∞–Ω–∞–ª–∏–∑—ã + –≠–ö–ì + –º–∞–º–º–æ–≥—Ä–∞—Ñ–∏—è (–≤—Å–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)',
           icon: 'ü©∫',
           services: getServicesByNames(['–¢–µ—Ä–∞–ø–µ–≤—Ç', '–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏ –æ–±—â–∏–π', '–ì–ª—é–∫–æ–∑–∞ –Ω–∞—Ç–æ—â–∞–∫', '–ì–ª–∏–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–µ–º–æ–≥–ª–æ–±–∏–Ω', '–≠–ö–ì', '–ú–∞–º–º–æ–≥—Ä–∞—Ñ–∏—è']),
           color: 'var(--primary-color)',
           bgColor: 'var(--certificates-bg)'
         },
         {
           stage: 2,
           title: 'üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞',
           description: '–£–ó–ò, –•–æ–ª—Ç–µ—Ä –≠–ö–ì –∏ –æ–Ω–∫–æ—Å–∫—Ä–∏–Ω–∏–Ω–≥',
           icon: 'üè•',
           services: getServicesByNames(['–£–ó–ò –æ—Ä–≥–∞–Ω–æ–≤ –º–∞–ª–æ–≥–æ —Ç–∞–∑–∞', '–•–æ–ª—Ç–µ—Ä –≠–ö–ì', '–¶–∏—Ç–æ–ª–æ–≥–∏—è (–º–∞–∑–æ–∫ –ü–∞–ø–∞–Ω–∏–∫–æ–ª–∞—É)', '–û–Ω–∫–æ–º–∞—Ä–∫–µ—Ä—ã']),
           color: 'var(--info-color)',
           bgColor: 'var(--info-bg)'
         },
         {
           stage: 3,
           title: 'üìã –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞',
           description: '–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
           icon: '‚úÖ',
           services: [], // –¢–µ—Ä–∞–ø–µ–≤—Ç –¥–ª—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è
           color: 'var(--success-color)',
           bgColor: 'var(--preconception-bg)',
           isFinal: true
         }
       ]

     default: // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
       return [
         {
           stage: 1,
           title: 'üöÄ –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ',
           description: '–í—Å–µ –≤—Ä–∞—á–∏-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã + –∞–Ω–∞–ª–∏–∑—ã + —Ñ–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏—è (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)',
           icon: 'üè•',
           services: getServicesByNames(['–û—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥', '–ù–∞—Ä–∫–æ–ª–æ–≥', '–ù–µ–≤—Ä–æ–ª–æ–≥', '–û—Ç–æ–ª–∞—Ä–∏–Ω–≥–æ–ª–æ–≥ (–õ–û–†)', '–î–µ—Ä–º–∞—Ç–æ–≤–µ–Ω–µ—Ä–æ–ª–æ–≥', '–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥', '–û—Ä—Ç–æ–ø–µ–¥', '–ü—Å–∏—Ö–æ–ª–æ–≥', '–ü—Å–∏—Ö–∏–∞—Ç—Ä', '–ì–∏–Ω–µ–∫–æ–ª–æ–≥', '–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏ –æ–±—â–∏–π', '–ê–Ω–∞–ª–∏–∑ –º–æ—á–∏', '–§–ª—é–æ—Ä–æ–≥—Ä–∞—Ñ–∏—è']),
           color: 'var(--accent-color)',
           bgColor: 'var(--screening-bg)'
         },
         {
           stage: 2,
           title: 'üìã –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞',
           description: '–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –≤—ã–¥–∞—á–∞ —Å–ø—Ä–∞–≤–∫–∏',
           icon: '‚úÖ',
           services: getServiceByName('–¢–µ—Ä–∞–ø–µ–≤—Ç'),
           color: 'var(--primary-color)',
           bgColor: 'var(--certificates-bg)',
           isFinal: true
         }
       ]
  }
}

// –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç —Å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏
const serviceRoute = computed(() => {
  if (!formData.value.selectedCertificate) return []
  
  // –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ç—Ä–µ–±—É–µ–º—ã–µ —É—Å–ª—É–≥–∏ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
  const requiredServices = services.filter(service => 
    formData.value.selectedCertificate!.requiredServices.includes(service.id)
  )
  
  const routes = getMedicalRoute(formData.value.selectedCertificate.id.toString(), requiredServices)
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º —ç—Ç–∞–ø—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —É—Å–ª—É–≥–∏ –∏–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏
  return routes.filter(route => route.services.length > 0 || route.isFinal)
})

const additionalServices = computed(() => {
  const requiredServiceIds = formData.value.selectedCertificate?.requiredServices || []
  const selectedServiceIds = formData.value.selectedServices.map(s => s.id)
  
  return services.filter(service => 
    !requiredServiceIds.includes(service.id) && 
    !selectedServiceIds.includes(service.id)
  )
})

const currentService = computed(() => {
  return formData.value.selectedServices[formData.value.currentServiceIndex]
})

const currentServiceBooking = computed(() => {
  return formData.value.serviceBookings[formData.value.currentServiceIndex]
})

const today = computed(() => {
  return new Date().toISOString().split('T')[0]
})

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —É—Å–ª—É–≥–∏ –∏ –¥–∞—Ç—ã
const availableTimeSlots = computed(() => {
  if (!currentServiceSchedule.value) return []
  return currentServiceSchedule.value.availableSlots
})

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –∑–∞–ø–∏—Å–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —É—Å–ª—É–≥–∏
const availableBookingOptions = computed(() => {
  const service = currentService.value
  if (!service) return { appointment: false, queue: false }
  
  const schedule = currentServiceSchedule.value
  const hasAvailableSlots = schedule && schedule.availableSlots.length > 0
  
  return {
    appointment: service.supportAppointments && hasAvailableSlots,
    queue: service.hasQueue
  }
})

// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–∏–ø –∑–∞–ø–∏—Å–∏
const recommendedBookingType = computed(() => {
  const options = availableBookingOptions.value
  
  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–ø–∏—Å—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  if (options.appointment) return 'appointment'
  if (options.queue) return 'queue'
  return null
})

const canProceedFromServices = computed(() => {
  return formData.value.selectedServices.length > 0
})

const canProceedFromBooking = computed(() => {
  const booking = currentServiceBooking.value
  if (!booking) return false
  
  if (booking.bookingType === 'appointment') {
    return booking.date && booking.time
  }
  return booking.bookingType === 'queue' && booking.date
})

const hasMoreServices = computed(() => {
  return formData.value.currentServiceIndex < formData.value.selectedServices.length - 1
})

const formattedDateTime = computed(() => {
  return (booking: ServiceBooking) => {
    if (!booking.date) return ''
    const date = new Date(booking.date)
    const options: Intl.DateTimeFormatOptions = { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      weekday: 'long'
    }
    const dateStr = date.toLocaleDateString('ru-RU', options)
    
    if (booking.bookingType === 'appointment' && booking.time) {
      return `${dateStr} –≤ ${booking.time}`
    } else if (booking.bookingType === 'queue') {
      const queueInfo = currentServiceSchedule.value?.queueInfo
      const timeInfo = queueInfo?.nextAvailableTime ? ` (–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ –≤ ${queueInfo.nextAvailableTime})` : ''
      return `${dateStr} - –∂–∏–≤–∞—è –æ—á–µ—Ä–µ–¥—å${timeInfo}`
    }
    return dateStr
  }
})

const totalCost = computed(() => {
  let total = 0
  if (formData.value.selectedCertificate) {
    total += formData.value.selectedCertificate.price
  }
  formData.value.selectedServices.forEach(service => {
    total += service.price
  })
  return total
})

const totalDuration = computed(() => {
  return formData.value.selectedServices.reduce((total, service) => total + service.duration, 0)
})

// –ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏
watch([currentService, () => currentServiceBooking.value?.date], async () => {
  if (currentService.value && currentServiceBooking.value?.date) {
    await updateServiceSchedule()
  }
})

// –ú–µ—Ç–æ–¥—ã
const updateServiceSchedule = async () => {
  const service = currentService.value
  const booking = currentServiceBooking.value
  
  if (!service || !booking?.date) {
    currentServiceSchedule.value = null
    return
  }
  
  currentServiceSchedule.value = getServiceSchedule(service.id, booking.date)
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–∏–ø –∑–∞–ø–∏—Å–∏
  if (recommendedBookingType.value && !booking.bookingType) {
    setBookingType(recommendedBookingType.value as 'appointment' | 'queue')
  }
}

const toggleGroup = (groupCategory: string) => {
  if (collapsedGroups.value.has(groupCategory)) {
    collapsedGroups.value.delete(groupCategory)
  } else {
    collapsedGroups.value.add(groupCategory)
  }
}

const isGroupCollapsed = (groupCategory: string) => {
  return collapsedGroups.value.has(groupCategory)
}

const selectCertificate = (certificate: Certificate) => {
  formData.value.selectedCertificate = certificate
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç—Ä–µ–±—É–µ–º—ã–µ —É—Å–ª—É–≥–∏
  const requiredServices = services.filter(service => 
    certificate.requiredServices.includes(service.id)
  )
  
  formData.value.selectedServices = [...requiredServices]
  formData.value.serviceBookings = requiredServices.map(service => ({
    service,
    bookingType: 'appointment', // –≤—Ä–µ–º–µ–Ω–Ω–æ, –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    date: today.value // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  }))
  
  formData.value.currentServiceIndex = 0
}

const toggleService = (service: Service) => {
  const index = formData.value.selectedServices.findIndex(s => s.id === service.id)
  if (index >= 0) {
    // –£–¥–∞–ª—è–µ–º —É—Å–ª—É–≥—É
    formData.value.selectedServices.splice(index, 1)
    formData.value.serviceBookings.splice(index, 1)
  } else {
    // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª—É–≥—É
    formData.value.selectedServices.push(service)
    formData.value.serviceBookings.push({
      service,
      bookingType: 'appointment', // –≤—Ä–µ–º–µ–Ω–Ω–æ, –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      date: today.value // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    })
  }
}

const addAdditionalService = (service: Service) => {
  formData.value.selectedServices.push(service)
  formData.value.serviceBookings.push({
    service,
    bookingType: 'appointment',
    date: today.value
  })
}

const isServiceSelected = (service: Service) => {
  return formData.value.selectedServices.some(s => s.id === service.id)
}

const setBookingType = (type: 'appointment' | 'queue') => {
  if (formData.value.serviceBookings[formData.value.currentServiceIndex]) {
    formData.value.serviceBookings[formData.value.currentServiceIndex].bookingType = type
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞
    if (type === 'queue') {
      formData.value.serviceBookings[formData.value.currentServiceIndex].time = undefined
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥–∏
      const queueInfo = getQueueInfo(currentService.value.id)
      formData.value.serviceBookings[formData.value.currentServiceIndex].queuePosition = queueInfo.length + 1
    }
  }
}

const setDate = async (date: string) => {
  if (formData.value.serviceBookings[formData.value.currentServiceIndex]) {
    formData.value.serviceBookings[formData.value.currentServiceIndex].date = date
    formData.value.serviceBookings[formData.value.currentServiceIndex].time = undefined
    await updateServiceSchedule()
  }
}

const handleDateInput = (event: Event) => {
  const target = event.target as HTMLInputElement
  setDate(target.value)
}

const setTime = (time: string) => {
  if (formData.value.serviceBookings[formData.value.currentServiceIndex]) {
    formData.value.serviceBookings[formData.value.currentServiceIndex].time = time
  }
}

const nextStep = () => {
  if (currentStep.value < 5) {
    currentStep.value = (currentStep.value + 1) as BookingStep
    
    // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —à–∞–≥ 3, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–π —É—Å–ª—É–≥–∏
    if (currentStep.value === 3) {
      formData.value.currentServiceIndex = 0
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–≤–æ–π —É—Å–ª—É–≥–∏
      if (currentService.value && currentServiceBooking.value?.date) {
        updateServiceSchedule()
      }
    }
  }
}

const prevStep = () => {
  if (currentStep.value > 1) {
    currentStep.value = (currentStep.value - 1) as BookingStep
  }
}

const nextService = () => {
  if (hasMoreServices.value) {
    formData.value.currentServiceIndex++
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —É—Å–ª—É–≥–∏
    if (currentService.value && currentServiceBooking.value?.date) {
      updateServiceSchedule()
    }
  } else {
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —É—Å–ª—É–≥–∞–º
    nextStep()
  }
}

const prevService = () => {
  if (formData.value.currentServiceIndex > 0) {
    formData.value.currentServiceIndex--
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π —É—Å–ª—É–≥–∏
    if (currentService.value && currentServiceBooking.value?.date) {
      updateServiceSchedule()
    }
  } else {
    prevStep()
  }
}

const skipAdditionalServices = () => {
  nextStep()
}

const confirmAllBookings = () => {
  console.log('All bookings confirmed:', {
    certificate: formData.value.selectedCertificate,
    serviceBookings: formData.value.serviceBookings
  })
  nextStep()
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å –¥–ª—è —É—Å–ª—É–≥ —Å –∂–∏–≤–æ–π –æ—á–µ—Ä–µ–¥—å—é
  formData.value.serviceBookings.forEach(booking => {
    if (booking.bookingType === 'queue') {
      queueInfo.value.length++
      queueInfo.value.estimatedWaitTime = queueInfo.value.length * 15
    }
  })
}

const resetForm = () => {
  currentStep.value = 1
  formData.value = {
    selectedCertificate: null,
    selectedServices: [],
    serviceBookings: [],
    currentServiceIndex: 0
  }
}

const printBookings = () => {
  let printContent = `
    –¢–ê–õ–û–ù –ó–ê–ü–ò–°–ò
    ============
    –°–ø—Ä–∞–≤–∫–∞: ${formData.value.selectedCertificate?.name}
    
    –£–°–õ–£–ì–ò:
  `
  
  formData.value.serviceBookings.forEach((booking, index) => {
    printContent += `
    ${index + 1}. ${booking.service.name}
       ${booking.bookingType === 'appointment' 
         ? `–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ${formattedDateTime.value(booking)}` 
         : '–¢–∏–ø –∑–∞–ø–∏—Å–∏: –ñ–∏–≤–∞—è –æ—á–µ—Ä–µ–¥—å'
       }
       –°—Ç–æ–∏–º–æ—Å—Ç—å: ${booking.service.price} ‚Ç∏
       –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${booking.service.duration} –º–∏–Ω
    `
  })
  
  printContent += `
    ============
    –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${totalCost.value} ‚Ç∏
    –û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${totalDuration.value} –º–∏–Ω
    ============
    –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏: ${new Date().toLocaleString('ru-RU')}
  `
  
  alert('–¢–∞–ª–æ–Ω –≥–æ—Ç–æ–≤ –∫ –ø–µ—á–∞—Ç–∏!\n\n' + printContent)
}

// –•—É–∫–∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
onMounted(() => {
  console.log('App mounted')
  
  // –ò–º–∏—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
  setInterval(() => {
    if (Math.random() > 0.7) {
      queueInfo.value.length = Math.max(0, queueInfo.value.length - 1)
      queueInfo.value.estimatedWaitTime = queueInfo.value.length * 15
    }
  }, 30000)
})
</script>

<template>
  <div id="app">
    <div class="container">
      <h1>üè• –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h1>
      
      <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
      <div class="progress-bar">
        <div class="progress-steps">
          <div 
            v-for="step in 5" 
            :key="step"
            class="progress-step"
            :class="{ 
              'active': currentStep === step, 
              'completed': currentStep > step 
            }"
          >
            {{ step }}
          </div>
        </div>
      </div>

      <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —Å–ø—Ä–∞–≤–∫–∏ -->
      <div v-if="currentStep === 1" class="step">
        <h2>üè• –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</h2>
        <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">
          –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
        </p>
        
        <!-- –ü–æ–∏—Å–∫ —Å–ø—Ä–∞–≤–æ–∫ -->
        <div class="search-section">
          <div class="search-box">
            <input 
              type="text" 
              v-model="searchQuery" 
              placeholder="üîç –ü–æ–∏—Å–∫ —Å–ø—Ä–∞–≤–æ–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..."
              class="search-input"
            >
            <button 
              v-if="searchQuery" 
              @click="searchQuery = ''" 
              class="search-clear"
            >
              ‚úï
            </button>
          </div>
          <div v-if="searchQuery && filteredCertificateGroups.length === 0" class="no-results">
            <p>üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "{{ searchQuery }}"</p>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
          </div>
        </div>
        
        <div class="certificate-groups">
          <div 
            v-for="group in filteredCertificateGroups" 
            :key="group.category"
            class="certificate-group"
          >
            <div class="group-header" @click="toggleGroup(group.category)">
              <div class="group-icon">{{ group.icon }}</div>
              <div class="group-info">
                <h3>{{ group.title }}</h3>
                <p>{{ group.description }}</p>
                <span class="group-count">{{ group.certificates.length }} {{ group.certificates.length === 1 ? '–≤–∞—Ä–∏–∞–Ω—Ç' : '–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤' }}</span>
              </div>
              <div class="group-toggle">
                <span class="toggle-icon" :class="{ 'collapsed': isGroupCollapsed(group.category) }">
                  {{ isGroupCollapsed(group.category) ? '‚ñº' : '‚ñ≤' }}
                </span>
              </div>
            </div>
            
            <div 
              class="group-certificates" 
              :class="{ 'collapsed': isGroupCollapsed(group.category) }"
            >
              <div 
                v-for="certificate in group.certificates" 
                :key="certificate.id"
                class="certificate-item"
                @click="selectCertificate(certificate)"
                :class="{ 'selected': formData.selectedCertificate?.id === certificate.id }"
              >
                <div class="certificate-icon">{{ certificate.icon }}</div>
                <div class="certificate-content">
                  <h4>{{ certificate.name }}</h4>
                  <p>{{ certificate.description }}</p>
                  <div class="certificate-meta">
                    <span class="price">{{ certificate.price }} ‚Ç∏</span>
                    <span class="services-count">{{ certificate.requiredServices.length }} {{ certificate.requiredServices.length === 1 ? '—É—Å–ª—É–≥–∞' : '—É—Å–ª—É–≥' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div v-if="formData.selectedCertificate" class="selected-certificate-summary">
          <div class="summary-card">
            <div class="summary-header">
              <span class="summary-icon">{{ formData.selectedCertificate.icon }}</span>
              <div>
                <h3>–í—ã–±—Ä–∞–Ω–æ: {{ formData.selectedCertificate.name }}</h3>
                <p>{{ formData.selectedCertificate.description }}</p>
              </div>
            </div>
            <div class="summary-footer">
              <span class="summary-price">{{ formData.selectedCertificate.price }} ‚Ç∏</span>
              <button @click="nextStep()" class="btn btn-primary">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- –®–∞–≥ 2: –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç -->
      <div v-if="currentStep === 2" class="step">
        <h2>üìã –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç</h2>
        <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">
          –°–ø—Ä–∞–≤–∫–∞ "{{ formData.selectedCertificate?.name }}" ‚Äî –ø–ª–∞–Ω –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —É—Å–ª—É–≥ –ø–æ —ç—Ç–∞–ø–∞–º
        </p>
        
        <div class="route-overview">
          <div class="route-header">
            <div class="route-icon">üó∫Ô∏è</div>
            <div class="route-info">
              <h3>–í–∞—à –º–∞—Ä—à—Ä—É—Ç –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</h3>
              <p>{{ serviceRoute.length }} —ç—Ç–∞–ø–∞ ‚Ä¢ {{ availableServices.length }} —É—Å–ª—É–≥ ‚Ä¢ {{ totalDuration }} –º–∏–Ω</p>
            </div>
            <div class="route-cost">
              <span class="cost-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
              <span class="cost-value">{{ totalCost }} ‚Ç∏</span>
            </div>
          </div>
          <div class="route-note">
            <span class="note-icon">üí°</span>
            <span>–≠—Ç–æ –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –≤–∞—à–µ–π —Å–ø—Ä–∞–≤–∫–∏. –í—ã –º–æ–∂–µ—Ç–µ —Å–Ω–∏–º–∞—Ç—å –≥–∞–ª–æ—á–∫–∏ —Å –Ω–µ–Ω—É–∂–Ω—ã—Ö —É—Å–ª—É–≥, –Ω–æ –ø–ª–∞–Ω –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ.</span>
          </div>
        </div>

        <div class="route-stages">
          <div 
            v-for="(stage, stageIndex) in serviceRoute" 
            :key="stage.stage"
            class="route-stage"
            :style="{ '--stage-color': stage.color, '--stage-bg': stage.bgColor }"
          >
            <div class="stage-header">
              <div class="stage-number">{{ stage.stage }}</div>
              <div class="stage-icon">{{ stage.icon }}</div>
              <div class="stage-info">
                <h3>{{ stage.title }}</h3>
                <p>{{ stage.description }}</p>
                <span class="stage-count">{{ stage.services.length }} {{ stage.services.length === 1 ? '—É—Å–ª—É–≥–∞' : '—É—Å–ª—É–≥' }}</span>
              </div>
              <div class="stage-duration">
                {{ stage.services.reduce((sum, s) => sum + s.duration, 0) }} –º–∏–Ω
              </div>
            </div>
            
            <div class="stage-services" v-if="!stage.isFinal">
              <div 
                v-for="service in stage.services" 
                :key="service.id"
                class="route-service"
                @click="toggleService(service)"
                :class="{ 
                  'selected': isServiceSelected(service),
                  'unselected': !isServiceSelected(service)
                }"
              >
                <div class="service-checkbox">
                  <span v-if="isServiceSelected(service)">‚úì</span>
                  <span v-else class="checkbox-empty">‚óã</span>
                </div>
                <div class="service-content">
                  <h4>{{ service.name }}</h4>
                  <p>{{ service.description }}</p>
                  <div class="service-meta">
                    <span class="duration">{{ service.duration }} –º–∏–Ω</span>
                    <span class="price">{{ service.price }} ‚Ç∏</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø - —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div v-if="stage.isFinal" class="final-stage-info">
              <div class="final-message">
                <p>{{ stage.description }}</p>
                <div class="final-note">
                  <span>üí°</span>
                  <span>–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –≤—Ä–∞—á –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –æ—Ñ–æ—Ä–º–∏—Ç —Å–ø—Ä–∞–≤–∫—É</span>
                </div>
              </div>
            </div>
            
            <!-- –°–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏ -->
            <div v-if="stageIndex < serviceRoute.length - 1" class="stage-connector">
              <div class="connector-line"></div>
              <div class="connector-arrow">‚Üì</div>
            </div>
          </div>
        </div>

        <div class="route-summary">
          <div class="summary-card">
            <h3>üìä –°–≤–æ–¥–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
            <div class="summary-stats">
              <div class="stat-item">
                <span class="stat-icon">‚è±Ô∏è</span>
                <span class="stat-label">–û–±—â–µ–µ –≤—Ä–µ–º—è:</span>
                <span class="stat-value">{{ totalDuration }} –º–∏–Ω</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon">üí∞</span>
                <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥:</span>
                <span class="stat-value">{{ formData.selectedServices.reduce((sum, s) => sum + s.price, 0) }} ‚Ç∏</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon">üìã</span>
                <span class="stat-label">–°–ø—Ä–∞–≤–∫–∞:</span>
                <span class="stat-value">{{ formData.selectedCertificate?.price }} ‚Ç∏</span>
              </div>
              <div class="stat-item total">
                <span class="stat-icon">üí≥</span>
                <span class="stat-label">–ò—Ç–æ–≥–æ:</span>
                <span class="stat-value">{{ totalCost }} ‚Ç∏</span>
              </div>
            </div>
          </div>
        </div>

        <div class="navigation">
          <button @click="prevStep()" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</button>
          <button 
            v-if="canProceedFromServices" 
            @click="nextStep()" 
            class="btn btn-primary"
          >
            –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ ‚Üí
          </button>
        </div>
      </div>

      <!-- –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏ -->
      <div v-if="currentStep === 3" class="step">
        <h2>‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø–∏—Å–∏</h2>
        <div class="service-progress">
          <p>–£—Å–ª—É–≥–∞ {{ formData.currentServiceIndex + 1 }} –∏–∑ {{ formData.selectedServices.length }}</p>
          <div class="progress-indicator">
            <div 
              v-for="(service, index) in formData.selectedServices" 
              :key="service.id"
              class="service-indicator"
              :class="{ 
                'active': index === formData.currentServiceIndex,
                'completed': index < formData.currentServiceIndex 
              }"
            >
              {{ index + 1 }}
            </div>
          </div>
        </div>

        <div v-if="currentService" class="current-service">
          <h3>üîπ {{ currentService.name }}</h3>
          <p>{{ currentService.description }}</p>
          <div class="service-info">
            <span>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ currentService.duration }} –º–∏–Ω</span>
            <span>–°—Ç–æ–∏–º–æ—Å—Ç—å: {{ currentService.price }} ‚Ç∏</span>
          </div>
        </div>

        <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã -->
        <div class="date-selection">
          <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h3>
          <div class="date-picker">
            <input 
              type="date" 
              :value="currentServiceBooking?.date || today"
              @input="handleDateInput"
              :min="today"
            >
          </div>
        </div>

        <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø–∏—Å–∏ -->
        <div v-if="currentServiceBooking?.date && currentServiceSchedule" class="smart-booking-options">
          <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã -->
          <div v-if="recommendedBookingType" class="recommendation">
            <div class="recommendation-badge">
              <span v-if="recommendedBookingType === 'appointment'">‚ú® –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∑–∞–ø–∏—Å—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏</span>
              <span v-else>‚ú® –î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∂–∏–≤–∞—è –æ—á–µ—Ä–µ–¥—å</span>
            </div>
            <p class="recommendation-text">
              <span v-if="recommendedBookingType === 'appointment'">
                –ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –µ—Å—Ç—å {{ availableTimeSlots.length }} —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
              </span>
              <span v-else>
                –ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞ –∂–∏–≤–∞—è –æ—á–µ—Ä–µ–¥—å
              </span>
            </p>
          </div>

          <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø–∏—Å–∏ -->
          <div class="booking-options">
            <!-- –ó–∞–ø–∏—Å—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
            <div 
              v-if="availableBookingOptions.appointment"
              class="option-card available" 
              @click="setBookingType('appointment')" 
              :class="{ 'selected': currentServiceBooking?.bookingType === 'appointment' }"
            >
              <div class="option-header">
                <h3>üìÖ –ó–∞–ø–∏—Å—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
                <span class="availability-badge available">–î–æ—Å—Ç—É–ø–Ω–æ {{ availableTimeSlots.length }} —Å–ª–æ—Ç–æ–≤</span>
              </div>
              <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —É—Å–ª—É–≥–∏</p>
            </div>
            
            <div 
              v-else-if="currentService?.supportAppointments"
              class="option-card unavailable"
            >
              <div class="option-header">
                <h3>üìÖ –ó–∞–ø–∏—Å—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
                <span class="availability-badge unavailable">–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</span>
              </div>
              <p>–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –≤—Å–µ —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω—è—Ç—ã</p>
            </div>
            
            <!-- –ñ–∏–≤–∞—è –æ—á–µ—Ä–µ–¥—å -->
            <div 
              v-if="availableBookingOptions.queue"
              class="option-card available" 
              @click="setBookingType('queue')" 
              :class="{ 'selected': currentServiceBooking?.bookingType === 'queue' }"
            >
              <div class="option-header">
                <h3>üïí –ñ–∏–≤–∞—è –æ—á–µ—Ä–µ–¥—å</h3>
                <span class="availability-badge available">–î–æ—Å—Ç—É–ø–Ω–æ</span>
              </div>
              <p>–ü—Ä–æ–π–¥–∏—Ç–µ —É—Å–ª—É–≥—É –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</p>
              <div v-if="currentServiceSchedule?.queueInfo" class="queue-preview">
                <small>
                  –í –æ—á–µ—Ä–µ–¥–∏: {{ currentServiceSchedule.queueInfo.length }} —á–µ–ª. 
                  (–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ {{ currentServiceSchedule.queueInfo.nextAvailableTime }})
                </small>
              </div>
            </div>

            <div 
              v-else-if="currentService?.hasQueue"
              class="option-card unavailable"
            >
              <div class="option-header">
                <h3>üïí –ñ–∏–≤–∞—è –æ—á–µ—Ä–µ–¥—å</h3>
                <span class="availability-badge unavailable">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
              </div>
              <p>–î–∞–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∂–∏–≤—É—é –æ—á–µ—Ä–µ–¥—å</p>
            </div>
          </div>

          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ -->
          <div v-if="!availableBookingOptions.appointment && !availableBookingOptions.queue" class="no-options">
            <div class="alert alert-warning">
              <h3>‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–ø–∏—Å–∏</h3>
              <p>–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –∑–∞–ø–∏—Å—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –¥–∞—Ç—É.</p>
            </div>
          </div>
        </div>

        <!-- –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
        <div v-if="currentServiceBooking?.bookingType === 'appointment' && currentServiceBooking?.date" class="time-selection">
          <h3>üïê –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h3>
          <div v-if="availableTimeSlots.length > 0" class="time-slots">
            <div class="time-grid">
              <button 
                v-for="time in availableTimeSlots" 
                :key="time"
                @click="setTime(time)"
                class="time-slot"
                :class="{ 'selected': currentServiceBooking?.time === time }"
              >
                {{ time }}
              </button>
            </div>
          </div>
          <div v-else class="no-time-slots">
            <p>–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</p>
          </div>
        </div>

        <!-- –î–µ—Ç–∞–ª–∏ –∂–∏–≤–æ–π –æ—á–µ—Ä–µ–¥–∏ -->
        <div v-if="currentServiceBooking?.bookingType === 'queue' && currentServiceSchedule?.queueInfo" class="queue-details">
          <div class="queue-info-card">
            <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—á–µ—Ä–µ–¥–∏</h3>
            <div class="queue-stats">
              <div class="stat">
                <span class="stat-label">–í –æ—á–µ—Ä–µ–¥–∏:</span>
                <span class="stat-value">{{ currentServiceSchedule.queueInfo.length }} —á–µ–ª–æ–≤–µ–∫</span>
              </div>
              <div class="stat">
                <span class="stat-label">–û–∂–∏–¥–∞–Ω–∏–µ:</span>
                <span class="stat-value">~{{ currentServiceSchedule.queueInfo.estimatedWaitTime }} –º–∏–Ω</span>
              </div>
              <div class="stat">
                <span class="stat-label">–ü—Ä–∏–µ–º –æ–∫–æ–ª–æ:</span>
                <span class="stat-value">{{ currentServiceSchedule.queueInfo.nextAvailableTime }}</span>
              </div>
            </div>
            <div class="queue-position" v-if="currentServiceBooking?.queuePosition">
              <p><strong>–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏: {{ currentServiceBooking.queuePosition }}</strong></p>
            </div>
          </div>
        </div>

        <div class="navigation">
          <button @click="prevService()" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</button>
          <button 
            v-if="canProceedFromBooking" 
            @click="nextService()" 
            class="btn btn-primary"
          >
            {{ hasMoreServices ? '–°–ª–µ–¥—É—é—â–∞—è —É—Å–ª—É–≥–∞ ‚Üí' : '–ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —É—Å–ª—É–≥–∞–º ‚Üí' }}
          </button>
        </div>
      </div>

      <!-- –®–∞–≥ 4: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ -->
      <div v-if="currentStep === 4" class="step">
        <h2>‚ûï –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h2>
        <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">
          –•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏?
        </p>

        <div v-if="additionalServices.length > 0" class="services-list">
          <div 
            v-for="service in additionalServices" 
            :key="service.id"
            class="service-item additional-service"
            @click="addAdditionalService(service)"
          >
            <div class="service-content">
              <h3>{{ service.name }}</h3>
              <p>{{ service.description }}</p>
              <div class="service-details">
                <div class="duration">{{ service.duration }} –º–∏–Ω</div>
                <div class="price">{{ service.price }} ‚Ç∏</div>
              </div>
            </div>
            <div class="add-button">+</div>
          </div>
        </div>

        <div v-else class="no-additional">
          <p>üéâ –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã!</p>
        </div>

        <div class="navigation">
          <button @click="prevStep()" class="btn btn-secondary">‚Üê –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º—è</button>
          <button @click="skipAdditionalServices()" class="btn btn-primary">
            –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–±–æ—Ä ‚Üí
          </button>
        </div>
      </div>

      <!-- –®–∞–≥ 5: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π -->
      <div v-if="currentStep === 5" class="step confirmation">
        <h2>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π</h2>
        
        <div class="booking-summary">
          <h3>üìÑ –î–µ—Ç–∞–ª–∏ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π</h3>
          
          <div class="certificate-info">
            <h4>üìã –°–ø—Ä–∞–≤–∫–∞</h4>
            <p>{{ formData.selectedCertificate?.name }} - {{ formData.selectedCertificate?.price }} ‚Ç∏</p>
          </div>

          <div class="services-info">
            <h4>üî¨ –£—Å–ª—É–≥–∏ ({{ formData.serviceBookings.length }})</h4>
            <div v-for="(booking, index) in formData.serviceBookings" :key="index" class="booking-item">
              <div class="booking-header">
                <h5>{{ index + 1 }}. {{ booking.service.name }}</h5>
                <span class="booking-price">{{ booking.service.price }} ‚Ç∏</span>
              </div>
              <div class="booking-details">
                <p>{{ booking.service.description }}</p>
                <div class="booking-meta">
                  <span>‚è±Ô∏è {{ booking.service.duration }} –º–∏–Ω</span>
                  <span v-if="booking.bookingType === 'appointment' && booking.date && booking.time">
                    üìÖ {{ formattedDateTime(booking) }}
                  </span>
                  <span v-else-if="booking.bookingType === 'queue'">
                    üïí –ñ–∏–≤–∞—è –æ—á–µ—Ä–µ–¥—å
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="summary-totals">
            <div class="total-row">
              <strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {{ totalCost }} ‚Ç∏</strong>
            </div>
            <div class="total-row">
              <strong>–û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ totalDuration }} –º–∏–Ω</strong>
            </div>
            <div class="total-row">
              <strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥: {{ formData.serviceBookings.length }}</strong>
            </div>
          </div>
        </div>
        
        <div class="actions">
          <button @click="resetForm()" class="btn btn-secondary">üîÑ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
          <button @click="printBookings()" class="btn btn-secondary">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —Ç–∞–ª–æ–Ω</button>
          <button @click="confirmAllBookings()" class="btn btn-primary">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
        </div>
      </div>
    </div>
  </div>
</template>
